# 🔐 로그인 필수 문의 시스템 업데이트

## 📋 변경 사항 요약

이 업데이트로 **문의하기 기능이 로그인 필수**로 변경되었습니다.

### 🎯 주요 변경점

#### 1. **문의 페이지 접근 제한**
- ❌ 비로그인 상태에서 `/contact` 접근 시 → `/auth?redirect=/contact`로 리다이렉트
- ✅ 로그인 후 자동으로 원래 페이지(contact)로 돌아옴

#### 2. **사용자 정보 자동 채우기**
- 로그인한 사용자의 이름, 이메일이 문의 폼에 자동 입력
- 이름과 이메일 필드는 **읽기 전용** (수정 불가)
- 로그인한 계정 정보로만 문의 가능

#### 3. **데이터베이스 정책**
- 문의 작성: 로그인한 사용자만 가능 (`user_id` 필수)
- 문의 조회: 본인이 작성한 문의만 조회 가능
- 관리자는 모든 문의 조회/삭제 가능

---

## 🔄 사용자 플로우

### 비로그인 사용자
```
1. 문의하기 클릭
   ↓
2. /contact 페이지 접근 시도
   ↓
3. 로그인 체크 → 실패
   ↓
4. /auth?redirect=/contact로 리다이렉트
   ↓
5. 로그인 또는 회원가입
   ↓
6. 자동으로 /contact 페이지로 이동
   ↓
7. 사용자 정보 자동 채움 (이름, 이메일)
   ↓
8. 문의 내용 작성 및 제출
```

### 로그인한 사용자
```
1. 문의하기 클릭
   ↓
2. /contact 페이지 즉시 접근
   ↓
3. 사용자 정보 자동 채움
   ↓
4. 문의 내용 작성 및 제출
```

---

## 📂 수정된 파일

### 1. `src/app/contact/page.tsx`
**변경 내용:**
- ✅ 로그인 체크 로직 추가
- ✅ 비로그인 시 `/auth?redirect=/contact`로 리다이렉트
- ✅ 로그인한 사용자 정보로 폼 자동 채우기
- ✅ 이름/이메일 필드를 읽기 전용으로 변경
- ✅ 로딩 상태 표시

### 2. `src/app/auth/page.tsx`
**변경 내용:**
- ✅ URL 파라미터 `redirect` 읽기 기능 추가
- ✅ 로그인 성공 시 `redirect` URL로 이동
- ✅ 회원가입 성공 시 `redirect` URL로 이동

### 3. `src/app/mypage/page.tsx`
**변경 내용:**
- ✅ 문의 조회를 `user_id`로만 제한 (이메일 매칭 제거)
- ✅ 로그인한 사용자만 본인 문의 조회 가능

### 4. `supabase-rls-login-required.sql` (신규)
**내용:**
- RLS 정책: 로그인한 사용자만 문의 작성/조회 가능
- 관리자는 모든 문의 조회/삭제 가능

### 5. `TROUBLESHOOTING.md`
**변경 내용:**
- ✅ RLS 정책 가이드 업데이트 (이메일 매칭 제거)

---

## 🔧 Supabase 설정 필요

### ⚠️ 중요: RLS 정책 업데이트 필수

프로젝트를 배포하기 전에 **반드시** Supabase에서 RLS 정책을 업데이트해야 합니다.

#### 설정 방법:

1. **Supabase Dashboard** 접속
   - https://supabase.com
   - 프로젝트 선택

2. **SQL Editor** 열기 (왼쪽 메뉴)

3. **`supabase-rls-login-required.sql` 파일 실행**
   - 파일 내용 복사
   - SQL Editor에 붙여넣기
   - **Run** 버튼 클릭

4. **정책 확인**
   ```sql
   SELECT * FROM pg_policies WHERE tablename = 'contacts';
   ```
   
   다음 정책이 보여야 합니다:
   - `Users can view own contacts` (SELECT)
   - `Authenticated users can insert contacts` (INSERT)
   - `Admins can view all contacts` (SELECT)
   - `Admins can delete contacts` (DELETE)

---

## ✅ 테스트 체크리스트

### 1. 비로그인 문의 차단 테스트
- [ ] 로그아웃 상태에서 `/contact` 접근
- [ ] 자동으로 `/auth?redirect=/contact`로 리다이렉트 확인
- [ ] 로그인 후 `/contact` 페이지로 돌아오는지 확인

### 2. 로그인 문의 테스트
- [ ] 로그인 후 `/contact` 페이지 접근
- [ ] 이름, 이메일이 자동으로 채워지는지 확인
- [ ] 이름, 이메일 필드가 수정되지 않는지 확인
- [ ] 문의 제출 성공 확인

### 3. 마이페이지 테스트
- [ ] `/mypage`에서 본인이 작성한 문의만 보이는지 확인
- [ ] 다른 사용자의 문의는 보이지 않는지 확인

### 4. 관리자 테스트
- [ ] 관리자 계정으로 `/admin` 접근
- [ ] 모든 사용자의 문의가 보이는지 확인
- [ ] 문의 삭제가 가능한지 확인

---

## 🎨 UI 변경 사항

### 문의 폼 (Contact Form)

**이전:**
```
┌─────────────────────────────────┐
│ 이름 *                          │
│ [              ] ← 입력 가능    │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│ 이메일 *                        │
│ [              ] ← 입력 가능    │
└─────────────────────────────────┘
```

**현재:**
```
┌─────────────────────────────────┐
│ 이름 *                          │
│ [홍길동] ← 읽기 전용 (회색)     │
│ 로그인한 계정 정보가 사용됩니다 │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│ 이메일 *                        │
│ [hong@example.com] ← 읽기 전용  │
│ 로그인한 이메일이 사용됩니다    │
└─────────────────────────────────┘
```

---

## 📊 장단점 분석

### ✅ 장점

1. **데이터 정확성**
   - 사용자 추적이 명확함
   - 중복 문의 방지

2. **보안 강화**
   - 스팸 문의 차단
   - 본인 문의만 조회 가능

3. **관리 편의성**
   - user_id로 정확한 사용자 매칭
   - 문의 이력 관리 용이

### ⚠️ 단점

1. **전환율 감소 가능성**
   - 로그인 단계 추가로 문의 장벽 상승
   - 익명 문의 불가

2. **사용자 불편**
   - 간단한 문의에도 회원가입 필요
   - 즉시 문의 불가

---

## 🔄 롤백 방법 (필요시)

이전 방식(비로그인 문의 허용)으로 되돌리려면:

### 1. 코드 롤백
```bash
git revert HEAD  # 최근 커밋 되돌리기
```

### 2. Supabase RLS 정책 변경
```sql
-- 기존 정책 삭제
DROP POLICY IF EXISTS "Authenticated users can insert contacts" ON contacts;

-- 누구나 문의 작성 가능으로 변경
CREATE POLICY "Anyone can insert contacts"
  ON contacts FOR INSERT
  WITH CHECK (true);
```

---

## 📝 추가 개선 아이디어

### 1. 소셜 로그인 추가
```typescript
// Google, Kakao, Naver 로그인 연동
const { data, error } = await supabase.auth.signInWithOAuth({
  provider: 'google'
});
```

### 2. 간편 문의 모달
- 로그인 없이 간단한 문의는 가능하도록
- 상세 문의는 로그인 필요

### 3. 문의 알림
- 문의 답변 시 이메일 알림
- 실시간 알림 (Supabase Realtime)

---

## 📞 지원

문제가 발생하면 다음을 참고하세요:
- `TROUBLESHOOTING.md`: 문제 해결 가이드
- `AUTH_GUIDE.md`: 인증 시스템 가이드
- `SUPABASE_EMAIL_TEMPLATE.md`: 이메일 설정 가이드

---

**업데이트 날짜:** 2025년 11월 3일  
**버전:** 2.0 - 로그인 필수 문의 시스템

